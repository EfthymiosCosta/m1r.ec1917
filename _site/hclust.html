<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>3. Hierarchical Clustering ‚Äì A First Tutorial on Cluster Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-f93c2b1f3f0577f377aefa4848a86a36.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script>
MathJax = {
  tex: {
    macros: {
      argmax: ['\\operatorname*{arg\\,max}', 1],
      argmin: ['\\operatorname*{arg\\,min}', 1]
    }
  }
};
</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">A First Tutorial on Cluster Analysis</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">0. Introduction: What is clustering?</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./dists.html"> 
<span class="menu-text">1. Distances &amp; Dissimilarities</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./kmeans_pam.html"> 
<span class="menu-text">2. Partitional Clustering</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./hclust.html" aria-current="page"> 
<span class="menu-text">3. Hierarchical Clustering</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./evalmetrics.html"> 
<span class="menu-text">4. Number Of Clusters &amp; Evaluation</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./projectideas.html"> 
<span class="menu-text">Project Ideas</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#types-of-hierarchical-clustering" id="toc-types-of-hierarchical-clustering" class="nav-link active" data-scroll-target="#types-of-hierarchical-clustering">Types of hierarchical clustering</a></li>
  <li><a href="#agglomerative-clustering-implementation" id="toc-agglomerative-clustering-implementation" class="nav-link" data-scroll-target="#agglomerative-clustering-implementation">Agglomerative Clustering Implementation</a></li>
  <li><a href="#linkage-criteria" id="toc-linkage-criteria" class="nav-link" data-scroll-target="#linkage-criteria">Linkage Criteria</a></li>
  <li><a href="#hierarchical-agglomerative-clustering-in-r" id="toc-hierarchical-agglomerative-clustering-in-r" class="nav-link" data-scroll-target="#hierarchical-agglomerative-clustering-in-r">Hierarchical Agglomerative Clustering in <code>R</code></a></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways">Key takeaways</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">3. Hierarchical Clustering</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><strong>Definition (Hierarchical Clustering):</strong> A clustering algorithm that builds a nested hierarchy of non-overlapping, exhaustive clusters, where each data point belongs to exactly one cluster is called a <em>hierarchical clustering algorithm</em>.</p>
<div class="think-note">
<p>‚ùì <strong>Does that mean we don‚Äôt have to fix the number of clusters?</strong></p>
<p>Precisely! Hierarchical clustering returns a whole hierarchy of cluster structures, thus telling the user what a partition into <span class="math inline">\(K = 2\)</span> or <span class="math inline">\(K = 3\)</span> or <span class="math inline">\(K = 10\)</span> clusters will look like for any integer value of <span class="math inline">\(K\)</span> in <span class="math inline">\(\{ 1, \ldots, n\}\)</span>. However, in practical applications, this is sometimes too much information; we usually only care about a partition into a fixed number of clusters <span class="math inline">\(K\)</span>.</p>
</div>
<section id="types-of-hierarchical-clustering" class="level2">
<h2 class="anchored" data-anchor-id="types-of-hierarchical-clustering">Types of hierarchical clustering</h2>
<p>There exist two ways to do hierarchical clustering:</p>
<ol type="1">
<li><strong>Agglomerative</strong> hierarchical clustering starts with <span class="math inline">\(K = n\)</span> clusters <em>(each observation forms its own cluster)</em> and recursively merges clusters until just <span class="math inline">\(K=1\)</span> cluster with all observations is obtained.</li>
<li><strong>Divisive</strong> hierarchical clustering starts with <span class="math inline">\(K=1\)</span> cluster <em>(all observations form a cluster together)</em> and recursively splits clusters until <span class="math inline">\(K=n\)</span> clusters are obtained, with each observation forming its own cluster.</li>
</ol>
<p>The theory and implementations described below refer to agglomerative hierarchical clustering.</p>
</section>
<section id="agglomerative-clustering-implementation" class="level2">
<h2 class="anchored" data-anchor-id="agglomerative-clustering-implementation">Agglomerative Clustering Implementation</h2>
<p>We present the steps used to perform hierarchical agglomerative clustering below:</p>
<ol type="1">
<li><strong>Initialise:</strong> Initialise <span class="math inline">\(n\)</span> clusters <span class="math inline">\(C_1 = \{ 1\}, \ldots, C_n = \{n\}\)</span> and <span class="math inline">\(t \leftarrow 1\)</span>.</li>
<li><strong>Compute dissimilarities</strong>: Construct dissimilarity/distance matrix <span class="math inline">\(D^{(0)}\)</span> with <span class="math inline">\(D^{(0)}_{i,j} = d(\mathbf{x}_i, \mathbf{x}_j)\)</span> for a dissimilarity/distance function <span class="math inline">\(d\)</span>.</li>
<li><strong>Recursive steps:</strong> Repeat the following steps until <span class="math inline">\(t = n-1\)</span>:</li>
</ol>
<!-- -->
<ol type="i">
<li><p><strong>Merge:</strong> Find the two clusters that are least dissimilar and merge them, i.e.&nbsp;merge clusters <span class="math inline">\(C_{i^*}, C_{j^*}\)</span> where <span class="math inline">\(i^*, j^*\)</span> are such that <span class="math inline">\(D^{(t-1)}_{i^*,j^*} = \min\limits_{i \neq j} D^{(t-1)}_{i,j}\)</span>.</p></li>
<li><p><strong>Update dissimilarities:</strong> Update matrix of dissimilarities by computing cluster dissimilarities with the merged cluster, i.e.&nbsp;<span class="math inline">\([D^{(t)}]_{i,j} = d(C_i, C_j) \ \forall 1 \leq i &lt; j \leq n-t\)</span>.</p></li>
<li><p><strong>Increment:</strong> Set <span class="math inline">\(t \leftarrow t + 1\)</span>.</p></li>
</ol>
<!-- -->
<ol start="4" type="1">
<li><strong>Output:</strong> Cluster hierarchy.</li>
</ol>
<div class="funfact-box">
<p>üí° <strong>Fun fact</strong></p>
<p>The implementation described above is for any general dissimilarity/distance function <span class="math inline">\(d\)</span>. In fact, the <code>R</code> implementation of hierarchical agglomerative clustering requires a dissimilarity/distance matrix as input, not the full data set as e.g.&nbsp;<code>kmeans</code>.</p>
</div>
<div class="think-note">
<p>‚ùì <strong>Dissimilarities between clusters?</strong></p>
<p>Look at step 3ii. of the above implementation; what does it mean to compute dissimilarities between two clusters <span class="math inline">\(C_i\)</span> and <span class="math inline">\(C_j\)</span>? How can we do that?</p>
</div>
</section>
<section id="linkage-criteria" class="level2">
<h2 class="anchored" data-anchor-id="linkage-criteria">Linkage Criteria</h2>
<p>One of the recursive steps of hierarchical agglomerative clustering involves constructing the matrix of dissimilarities so that an element <span class="math inline">\((i, j)\)</span> represents the dissimilarity between clusters <span class="math inline">\(C_i\)</span> and <span class="math inline">\(C_j\)</span>. However, clusters are (non-empty) sets of observations, so how can we apply a dissimilarity function on them? This can be done by specifying the dissimilarity of any two clusters as a function of the pairwise distances of observations included in these. This is precisely what a <strong>linkage criterion</strong> does! The table below displays some of the most commonly-used linkage criteria that can be used:</p>
<table class="caption-top table">
<caption>Linkage criteria</caption>
<colgroup>
<col style="width: 25%">
<col style="width: 75%">
</colgroup>
<thead>
<tr class="header">
<th>Linkage</th>
<th>Formula</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Complete</td>
<td><span class="math inline">\(\max\limits_{\mathbf{x}_{i'} \in C_i, \mathbf{x}_{j'} \in C_j}d(\mathbf{x}_{i'}, \mathbf{x}_{j'})\)</span></td>
</tr>
<tr class="even">
<td>Single</td>
<td><span class="math inline">\(\min\limits_{\mathbf{x}_{i'} \in C_i, \mathbf{x}_{j'} \in C_j}d(\mathbf{x}_{i'}, \mathbf{x}_{j'})\)</span></td>
</tr>
<tr class="odd">
<td>Average</td>
<td><span class="math inline">\(\frac{1}{\lvert C_i \rvert}\frac{1}{\lvert C_j \rvert}\sum\limits_{\mathbf{x}_{i'} \in C_i}\sum\limits_{\mathbf{x}_{j'} \in C_j} d(\mathbf{x}_{i'}, \mathbf{x}_{j'})\)</span></td>
</tr>
<tr class="even">
<td>Ward</td>
<td><span class="math inline">\(\frac{\lvert C_i \rvert \lvert C_j \rvert}{\lvert C_i \cup C_j \rvert} \| \mathbf{m}_i - \mathbf{m}_j \|^2\)</span>, <span class="math inline">\(\mathbf{m}_k\)</span> is the centroid of cluster <span class="math inline">\(C_k\)</span></td>
</tr>
<tr class="odd">
<td>Centroid</td>
<td><span class="math inline">\(\| \mathbf{m}_i - \mathbf{m}_j \|^2\)</span>, <span class="math inline">\(\mathbf{m}_k\)</span> is the centroid of cluster <span class="math inline">\(C_k\)</span></td>
</tr>
</tbody>
</table>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>ü§î Quiz: Let <span class="math inline">\(C_1 = \{1, 2\}\)</span> and <span class="math inline">\(C_2 = \{3, 4\}\)</span> , where:
</div>
</div>
<div class="callout-body-container callout-body">
<p><span class="math display">\[
\mathbf{X} = \begin{pmatrix}0 &amp; 0 \\ 1 &amp; -2 \\ 5 &amp; -1 \\ 2 &amp; 2\end{pmatrix}.
\]</span> What is the dissimilarity between <span class="math inline">\(C_1\)</span> and <span class="math inline">\(C_2\)</span> using the Euclidean distance and the single linkage?</p>
<p>A. <span class="math inline">\(\sqrt{5}\)</span><br>
B. <span class="math inline">\(\sqrt{8}\)</span><br>
C. <span class="math inline">\(\sqrt{17}\)</span><br>
D. <span class="math inline">\(\sqrt{26}\)</span><br>
</p>
<details>
<summary>
Show Answer
</summary>
<p><strong>B.</strong> <span class="math inline">\(\sqrt{8}\)</span></p>
<p>Try computing the dissimilarity between <span class="math inline">\(C_1\)</span> and <span class="math inline">\(C_2\)</span> using different linkage criteria. How does that change?</p>
</details>
</div>
</div>
</section>
<section id="hierarchical-agglomerative-clustering-in-r" class="level2">
<h2 class="anchored" data-anchor-id="hierarchical-agglomerative-clustering-in-r">Hierarchical Agglomerative Clustering in <code>R</code></h2>
<p>Hierarchical agglomerative clustering is available in <code>R</code> using the <code>hclust</code> function. This takes a dissimilarity matrix and a linkage criterion as input arguments. Let us look at an example on a synthetic data set about climate in 10 European cities. The data includes the average temperature, annual precipitation and sunshine hours recorded over a year. We use agglomerative clustering with the Euclidean distance and complete linkage to obtain a cluster hierarchy. Notice that we can plot the hierarchy using <code>plot</code>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data set of European cities with their climate characteristics</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>cities <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">avg_temp =</span> <span class="fu">c</span>(<span class="dv">9</span>, <span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">16</span>, <span class="dv">18</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">12</span>, <span class="dv">14</span>, <span class="dv">17</span>),</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">annual_rain =</span> <span class="fu">c</span>(<span class="dv">600</span>, <span class="dv">750</span>, <span class="dv">500</span>, <span class="dv">450</span>, <span class="dv">400</span>, <span class="dv">800</span>, <span class="dv">850</span>, <span class="dv">650</span>, <span class="dv">550</span>, <span class="dv">480</span>),</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">sunshine_hours =</span> <span class="fu">c</span>(<span class="dv">1600</span>, <span class="dv">1500</span>, <span class="dv">2500</span>, <span class="dv">2800</span>, <span class="dv">2900</span>, <span class="dv">1400</span>, <span class="dv">1300</span>, <span class="dv">2000</span>, <span class="dv">2400</span>, <span class="dv">2700</span>),</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">row.names =</span> <span class="fu">c</span>(<span class="st">"London"</span>, <span class="st">"Paris"</span>, <span class="st">"Madrid"</span>, <span class="st">"Rome"</span>, <span class="st">"Athens"</span>, </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Stockholm"</span>, <span class="st">"Oslo"</span>, <span class="st">"Berlin"</span>, <span class="st">"Vienna"</span>, <span class="st">"Barcelona"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform hierarchical clustering</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>dist_matrix <span class="ot">&lt;-</span> <span class="fu">dist</span>(<span class="fu">scale</span>(cities))</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>hc <span class="ot">&lt;-</span> <span class="fu">hclust</span>(<span class="at">d =</span> dist_matrix,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>             <span class="at">method =</span> <span class="st">"complete"</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the hierarchy</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(hc, <span class="at">main =</span> <span class="st">"Hierarchical Clustering of European Cities by Climate"</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"City"</span>, <span class="at">ylab =</span> <span class="st">"Distance"</span>, <span class="at">sub =</span> <span class="st">""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hclust_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="funfact-box">
<p>üí° <strong>Fun fact</strong></p>
<p>The plot of hierarchies is called a <strong>dendrogram</strong> and comes from the Greek word ‚ÄúŒ¥Œ≠ŒΩŒ¥œÅŒø‚Äù (<em>dendro</em>) which means ‚Äútree‚Äù. Do you see why a tree diagram is used here?</p>
</div>
<div class="think-note">
<p>‚ùì <strong>Scaled data?</strong></p>
<p>Take a look at the line where the dissimilarity matrix is constructed: <code>dist_matrix &lt;- dist(scale(cities))</code>. What does the <code>scale</code> function do? <em>(Hint: Type <code>?scale</code> in your console to get the function documentation)</em>. Do you understand why it is used?</p>
</div>
<p>The dendrogram above shows how the cluster hierarchy is formed. We can also inspect the output of our hierarchical clustering output <code>hc</code>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(hc)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 7
 $ merge      : int [1:9, 1:2] -4 -3 -6 -5 -1 -2 2 3 7 -10 ...
 $ height     : num [1:9] 0.333 0.421 0.421 0.646 0.974 ...
 $ order      : int [1:10] 3 9 5 4 10 6 7 2 1 8
 $ labels     : chr [1:10] "London" "Paris" "Madrid" "Rome" ...
 $ method     : chr "complete"
 $ call       : language hclust(d = dist_matrix, method = "complete")
 $ dist.method: chr "euclidean"
 - attr(*, "class")= chr "hclust"</code></pre>
</div>
</div>
<p>Two of the objects returned can help us understand how the clustering algorithm has proceeded:</p>
<ul>
<li><code>merge</code>: A matrix of dimensions <span class="math inline">\((n-1) \times 2\)</span> that describes the merges done. Positive values indicate clusters obtained by previous merges.</li>
<li><code>height</code>: A vector of the <span class="math inline">\(n-1\)</span> values describing the dissimilarity between the merged clusters at each merging step.</li>
</ul>
<p>For instance, if we look at our data set, <code>merge</code> looks like this:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(hc<span class="sc">$</span>merge)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>      [,1] [,2]
 [1,]   -4  -10
 [2,]   -3   -9
 [3,]   -6   -7
 [4,]   -5    1
 [5,]   -1   -8
 [6,]   -2    5
 [7,]    2    4
 [8,]    3    6
 [9,]    7    8</code></pre>
</div>
</div>
<p>This tells us that the hierarchy was obtained as follows:</p>
<p>Step 1: <span class="math inline">\(\{4\} \cup \{10\}\)</span> ‚Üí Cluster 1</p>
<p>Step 2: <span class="math inline">\(\{3\} \cup \{9\}\)</span> ‚Üí Cluster 2</p>
<p>Step 3: <span class="math inline">\(\{6\} \cup \{7\}\)</span> ‚Üí Cluster 3</p>
<p>Step 4: <span class="math inline">\(\{5\} \cup\)</span> Cluster 1 ‚Üí Cluster 4 (<span class="math inline">\(\{4, 10, 5\}\)</span>)</p>
<p>Step 5: <span class="math inline">\(\{1\} \cup \{8\}\)</span> ‚Üí Cluster 5</p>
<p>Step 6: <span class="math inline">\(\{2\} \cup\)</span> Cluster 5 ‚Üí Cluster 6 (<span class="math inline">\(\{1, 8, 2\}\)</span>)</p>
<p>Step 7: Cluster 2 + Cluster 4 ‚Üí Cluster 7 (<span class="math inline">\(\{3,9,4,10,5\}\)</span>)</p>
<p>Step 8: Cluster 3 + Cluster 6 ‚Üí Cluster 8 (<span class="math inline">\(\{6,7,1,8,2\}\)</span>)</p>
<p>Step 9: Cluster 7 + Cluster 8 ‚Üí Final cluster (<span class="math inline">\(\{1, 2, 3, 4, 5, 6, 7, 8, 9, 10\}\)</span>)</p>
<p>The associated dissimilarities that led to these merges are:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(hc<span class="sc">$</span>height)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3333612 0.4213636 0.4213636 0.6456208 0.9737931 1.1188796 1.5318198
[8] 2.1567316 4.6816562</code></pre>
</div>
</div>
<div class="think-note">
<p>‚ùì <strong>Non-decreasing <code>height</code> values</strong></p>
<p>The values in <code>height</code> are always non-decreasing. Can you explain why?</p>
</div>
<p>We now have our cluster hierarchy but how do we get access to the clusters? The idea is that we can ‚Äúcut the tree‚Äù structure we got in the dendrogram and look at the clusters obtained. We can either cut at a specific height, or enforce a specific number of clusters. For instance, in the chunk below, we cut the tree into <span class="math inline">\(K=3\)</span> clusters and then we also cut it at a height of 3. Both actions can be performed using the <code>cutree</code> function. We can also visualise the obtained partitions on the dendrogram with <code>rect.hclust</code>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cut to get 3 clusters</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>hc_clust1 <span class="ot">&lt;-</span> <span class="fu">cutree</span>(<span class="at">tree =</span> hc,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">k =</span> <span class="dv">3</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Cut at a height of 3</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>hc_clust2 <span class="ot">&lt;-</span> <span class="fu">cutree</span>(<span class="at">tree =</span> hc,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">h =</span> <span class="dv">3</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the hierarchy and obtained partitions</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(hc, <span class="at">main =</span> <span class="st">"Hierarchical Clustering of European Cities by Climate"</span>,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"City"</span>, <span class="at">ylab =</span> <span class="st">"Distance"</span>, <span class="at">sub =</span> <span class="st">""</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="fu">rect.hclust</span>(hc, <span class="at">k =</span> <span class="dv">3</span>, <span class="at">border =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>, <span class="st">"darkgreen"</span>))</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="fu">rect.hclust</span>(hc, <span class="at">h =</span> <span class="dv">3</span>, <span class="at">border =</span> <span class="fu">c</span>(<span class="st">"magenta"</span>, <span class="st">"orange"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hclust_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As we can see, a height of 3 has returned a partition into <span class="math inline">\(K=2\)</span> clusters. In general, cutting a tree at a given height is not straightforward and requires inspecting the dendrogram in advance. This is why we normally prefer to cut in a way that allows specifying the number of clusters. Notice that cutting the tree at different heights may lead to the exact same partition in many cases.</p>
<div class="think-note">
<p>‚ùì <strong>Agglomerative vs.&nbsp;Divisive hierarchical clustering</strong></p>
<p>Agglomerative clustering is sometimes referred to as a ‚Äúbottom-up‚Äù approach, whereas the term ‚Äútop-down‚Äù is used to describe divisive clustering. Can you explain why? Relate your answer to the denrogram and what it illustrates.</p>
</div>
<div class="funfact-box">
<p>üöÄ <strong>Time to practice!</strong></p>
<p>The mtcars data set includes eleven features related to the design and the performance of 32 cars. Load the <code>mtcars</code> data in <code>R</code> (just use <code>data(iris)</code> to load it to your working environment). Keep only the purely numeric variables (i.e.&nbsp;remove the two binary variables <code>vs</code> and <code>am</code>) and perform hierarchical clustering with different combinations of dissimilarity functions and linkage criteria. Plot dendrograms for some of the obtained cluster hierarchies and try to identify whether your partitions make sense for different numbers of clusters.</p>
<p><em>(You may find it helpful to look at the car model names by typing <code>row.names(mtcars)</code>. Documentation for the data set is available by typing <code>?mtcars</code>).</em></p>
</div>
</section>
<section id="key-takeaways" class="level2">
<h2 class="anchored" data-anchor-id="key-takeaways">Key takeaways</h2>
<ul>
<li>Hierarchical clustering algorithms produce a hierarchy of partitions from <span class="math inline">\(K=1\)</span> up to <span class="math inline">\(K=n\)</span> exhaustive, non-overlapping clusters.</li>
<li>There are 2 main approaches to hierarchical clustering; agglomerative and divisive.</li>
<li>Hierarchical clustering can work with any dissimilarity function.</li>
<li>Linkage criteria specify the dissimilarity of any two clusters as a function of the pairwise distances of observations included in these.</li>
<li>Cluster hierarchies can be visualised using dendrograms.</li>
<li>Hierarchical agglomerative clustering is implemented in <code>R</code> using <code>hclust</code>.</li>
</ul>



</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/EfthymiosCosta\.github\.io\/m1r\.ec1917\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>